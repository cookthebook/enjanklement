<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="css/spectre/spectre.min.css">
  <link rel="stylesheet" href="css/spectre/spectre-exp.min.css">
  <link rel="stylesheet" href="css/spectre/spectre-icons.min.css">
</head>

<body class="container">
  <div id="JankNavbar"></div>

  <div class="container" id="MainContainer" style="min-width: 20rem; max-width: 40rem;" hidden>
    <h2>Deck Tool</h2>

    <p>
      This tool allows you to construct and check the legality of Jank decks!
      If you are happy with the list you've created, you can click the "Export"
      button to save the list to a file which can be imported again later, or
      shared with others. Follow the steps below to get deck building!
    </p>

    <div class="form-group p-centered">
      <h4>Step 0: Import</h4>
      <p>Already made and exported a deck? You can import it with this button! &#128071;</p>
      <button class="btn btn-primary p-centered" id="importBtn">Import</button>
      <input type="file" id="importFile" hidden></input>
      <br />

      <h4>Step 1: Deck Name</h4>
      <p>
        Every great deck has a name to remember it by. Jank and Taxes? Hedron Ajankment?
        The only limit is your imagination! &#128588;&#127752;&#128588;
      </p>
      <input type="text" class="form-input" placeholder="Enter your deck name" id="deckName"></input>
      <br />

      <h4>Step 2: Class Selection</h4>
      <p>
        Choose your fighter! These classes define what kinds of cards you can use and decks you can build.
        Select wisely, Planeswalker...
      </p>
      <div class="form-group" id="classForm">
        <label class="form-radio">
          <input type="radio" name="classSelect" id="jankwalker" checked>
            <figure class="avatar avatar-xl c-hand p-centered">
              <img src="media/jankwalker_pfp.png" alt="jankwalker profile pic">
              <i class="avatar-presence online" id="jankwalkerPresence"></i>
            </figure>
            <h5 class="p-centered text-center">The JankWalker</h5>
          </input>
          <div class="p-centered text-center">
            55 card, 22 point mainboard with an 11 card, 11 point sideboard - using any amount of <b>Standard</b> sets
          </div>
          </label>
        <label class="form-radio">
          <input type="radio" name="classSelect" id="jankbringer">
            <figure class="avatar avatar-xl c-hand p-centered">
              <img src="media/jankbringer_pfp.png" alt="jankbringer profile pic">
              <i class="avatar-presence online" id="jankbringerPresence" hidden></i>
            </figure>
            <h5 class="p-centered text-center">The JankBringer</h5>
          </input>
          <div class="p-centered text-center">
            60 card, 22 point mainboard with a 12 card, 12 point sideboard - using up to 4 <b>Pioneer</b> sets
          </div>
        </label>
      </div>
      <br />

      <h4>Step 3. Feat Selection</h4>
      <p>
        Feats are modifications that give your deck powerful benefits (at a cost, of course &#128527;).
        Hover over any of the &#10090;?&#10091; for more information about a feat.
      </p>
      <label class="form-switch">
        <input type="checkbox" id="ungabunga" />
        <i class="form-icon"></i> Unga Bunga
        <div class="popover popover-right">
          &#10090;?&#10091;
          <div class="popover-container">
            <div class="card">
              <div class="card-body">
                Forgo a sideboard to increase starting points by 2
              </div>
            </div>
          </div>
        </div>
      </label>
      <label class="form-switch">
        <input type="checkbox" id="doubledown">
        <i class="form-icon"></i> Double Down
        <div class="popover popover-right">
          &#10090;?&#10091;
          <div class="popover-container">
            <div class="card">
              <div class="card-body">
                Reduce deck size by 10 cards and 2 points, no 3-ofs allowed (incompatible with Down to One)
              </div>
            </div>
          </div>
        </div>
      </label>
      <label class="form-switch">
        <input type="checkbox" id="downtoone">
        <i class="form-icon"></i> Down to One
        <div class="popover popover-right">
          &#10090;?&#10091;
          <div class="popover-container">
            <div class="card">
              <div class="card-body">
                Reduce deck size by 20 cards and 4 points, singletons only (incompatible with Double Down)
              </div>
            </div>
          </div>
        </div>
      </label>
      <label class="form-switch">
        <input type="checkbox" id="quantumenjanklement">
        <i class="form-icon"></i> Quantum Enjanklement
        <div class="popover popover-right">
          &#10090;?&#10091;
          <div class="popover-container">
            <div class="card">
              <div class="card-body">
                Spend 1 maindeck point to "enjankle" two legendary cards
              </div>
            </div>
          </div>
        </div>
      </label>
      <label class="form-switch">
        <input type="checkbox" id="newtoys">
        <i class="form-icon"></i> New Toys
        <div class="popover popover-right">
          &#10090;?&#10091;
          <div class="popover-container">
            <div class="card">
              <div class="card-body">
                If two or more sets are Standard legal, you get +1 set (unavailable for JankWalker)
              </div>
            </div>
          </div>
        </div>
      </label>
      <br />

      <h4>Step 4. Set Selection</h4>
      <p>Choose which sets you want to include for your deck (not applicable to JankWalker, which can use all Standard sets).</p>
      <div id="setSelectForm" hidden>
      </div>
      <br />

      <h4>Step 5. Card Selection</h4>
      <p>
        The part we've been waiting for... constructing your deck &#128526;!
        Input every card name and the number you want for your main board and side board.
        Remember, decks can only have 6 2-ofs and 3 3-ofs (except for basic lands) - feats can modify this rule though.
        The rest have to be singleton!
      <h5>Main Board</h5>
      <div id="mainBoard"></div>

      <h5>Side Board</h5>
      <div id="sideBoard"></div>

      <br />

      <button class="btn btn-primary" id="checkBtn">Check</button>
      <button class="btn btn-primary" id="exportBtn">Export</button>
    </div>
    <div id="checkerOutput" class="p-centered text-center"></div>
  </div>
</body>

<script src="js/fuzzysort.js"></script>
<script type="module" src="js/jank.js"></script>
<script type="module" src="js/card_lister.js"></script>
<script type="module">
  import {
    checker_factory,
    download_sets,
    FORMATS,
    JANKBRINGER_DB,
    JANKWALKER_DB,
    BASIC_LANDS
  } from './js/jank.js';
  import { CardLister } from './js/card_lister.js';

  var deck_name = document.getElementById('deckName');

  var main_list = new CardLister(document.getElementById('mainBoard'));
  var side_list = new CardLister(document.getElementById('sideBoard'));

  var jankwalker_db = null;
  var jankbringer_db = null;
  var check_btn = document.getElementById('checkBtn');
  var import_btn = document.getElementById('importBtn');
  var import_file = document.getElementById('importFile');
  var export_btn = document.getElementById('exportBtn');

  var class_form = document.getElementById('classForm');
  var class_radios = document.getElementsByName('classSelect');
  var set_list = document.getElementById('setSelectForm');
  var set_selects = [];

  var unga = document.getElementById('ungabunga');
  var double_down = document.getElementById('doubledown');
  var down_to_one = document.getElementById('downtoone');
  var quantum = document.getElementById('quantumenjanklement');
  var new_toys = document.getElementById('newtoys');



  function selected_class() {
    for (let i = 0, length = class_radios.length; i < length; i++) {
      if (class_radios[i].checked) {
        return class_radios[i].id;
      }
    }

    return '';
  }

  function get_mod_list() {
    var mods = [];

    if (unga.checked) {
      mods.push('ungabunga');
    }
    if (double_down.checked) {
      mods.push('doubledown');
    }
    if (down_to_one.checked) {
      mods.push('downtoone');
    }
    if (quantum.checked) {
      mods.push('quantumenjanklement');
    }
    if (new_toys.checked) {
      mods.push('newtoys');
    }

    return mods;
  }

  function create_set_select(sets) {
    var ret = document.createElement('div');
    var ret_html = '<select class="form-select">';

    sets = sets.sort();

    sets.forEach(set => {
      ret_html += `<option value="${set}">${set.toUpperCase()}</option>`;
    });
    ret_html += '</select>'
    ret.innerHTML = ret_html;

    return ret;
  }
  function render_set_select() {
    while (set_list.firstChild) {
      set_list.firstChild.remove();
    }
    set_selects = [];

    var set_form = document.createElement('form');
    set_form.classList.add('form-horizontal');
    set_form.id = 'setSelectOptions';
    set_list.appendChild(set_form);

    var set_form_div = document.createElement('div');
    set_form_div.classList.add('form-group');
    set_form.appendChild(set_form_div);

    var new_select = create_set_select(FORMATS['pioneer']);
    set_form_div.appendChild(new_select);
    set_selects.push(new_select.firstChild);
    new_select = create_set_select(FORMATS['pioneer']);
    set_form_div.appendChild(new_select);
    set_selects.push(new_select.firstChild);
    new_select = create_set_select(FORMATS['pioneer']);
    set_form_div.appendChild(new_select);
    set_selects.push(new_select.firstChild);

    /* new toys allows for an extra set if two are standard */
    if (new_toys.checked) {
      new_select = create_set_select(FORMATS['standard']);
      set_form_div.appendChild(new_select);
      set_selects.push(new_select.firstChild);
      new_select = create_set_select(FORMATS['standard']);
      set_form_div.appendChild(new_select);
      set_selects.push(new_select.firstChild);
    } else {
      new_select = create_set_select(FORMATS['pioneer']);
      set_form_div.appendChild(new_select);
      set_selects.push(new_select.firstChild);
    }
  }
  function get_set_list() {
    var set_form = document.getElementById('setSelectOptions');

    if (!set_form) {
      return [];
    }

    var ret = [];
    for (let i = 0; i < set_selects.length; i++) {
      ret.push(set_selects[i].value);
    }

    return ret;
  }



  /* new toys is incompatible with jankwalker */
  function select_class() {
    for (let i = 0, length = class_radios.length; i < length; i++) {
      let presence = document.getElementById(class_radios[i].id + 'Presence');

      presence.hidden = !class_radios[i].checked;
    }

    console.debug('Select class', selected_class());
    if (selected_class() === 'jankwalker') {
      new_toys.checked = false;
      new_toys.disabled = true;
      set_list.hidden = true;
      main_list.set_card_db(JANKWALKER_DB, BASIC_LANDS);
      side_list.set_card_db(JANKWALKER_DB, BASIC_LANDS);
    } else {
      new_toys.disabled = false;
      render_set_select();
      set_list.hidden = false;
      main_list.set_card_db(JANKBRINGER_DB, BASIC_LANDS);
      side_list.set_card_db(JANKBRINGER_DB, BASIC_LANDS);
    }
  }
  class_form.addEventListener('input', () => {
    console.debug('class form input');
    select_class();
  });

  /* double_down and down_to_one are mutually exclusive */
  double_down.addEventListener('input', () => {
    if (down_to_one.checked && double_down.checked) {
      down_to_one.checked = false;
    }
  });
  down_to_one.addEventListener('input', () => {
    if (down_to_one.checked && double_down.checked) {
      double_down.checked = false;
    }
  });

  /* re-render set select if new toys gets checked */
  new_toys.addEventListener('input', () => {
    render_set_select();
  });



  function check_deck() {
    /* construct deck checker based on selected options */
    var checker;

    checker = checker_factory(selected_class(), get_mod_list(), get_set_list());

    var deck = {
      main: main_list.get_card_list(),
      side: side_list.get_card_list()
    };
    console.debug(deck);

    var result = checker.check(deck, document.getElementById('checkerOutput'));
  }



  check_btn.addEventListener('click', () => {
    check_deck();
  });
  var main_container = document.getElementById('MainContainer');
  download_sets().then(() => {
    main_container.hidden = false;
    window.addEventListener("beforeunload", (event) => {
      event.returnValue = true;
    });
    select_class();
  });


  function import_deck() {
    var file = import_file.files[0];

    file.text().then(text => {
      var parse = JSON.parse(text);
      console.debug(parse);

      deck_name.value = parse.deck_name;

      for (let i = 0; i < class_radios.length; i++) {
        if (class_radios[i].id === parse.class) {
          class_radios[i].checked = true;
          select_class();
          break;
        }
      }

      for (let i = 0; i < parse.mods.length; i++) {
        var mod_elem = document.getElementById(parse.mods[i]);

        if (!mod_elem) {
          console.debug('No mod', parse.mods[i]);
          continue;
        }

        mod_elem.checked = true;
      }

      for (let i = 0; i < set_selects.length && i < parse.set_list.length; i++) {
        console.debug('Select set', parse.set_list[i]);
        set_selects[i].value = parse.set_list[i];
      }

      main_list.import(parse.main);
      side_list.import(parse.side);

      import_file.removeEventListener('change', import_deck);
    });
  }

  function wait_for_deck() {
    import_file.addEventListener('change', import_deck);
    import_file.click();
  }

  function export_deck() {
    var output = {
      deck_name: deck_name.value,
      class: selected_class(),
      mods: get_mod_list(),
      set_list: get_set_list(),
      main: main_list.get_card_list(),
      side: side_list.get_card_list()
    };
    var blob = new Blob([JSON.stringify(output, null, 2)]);
    const bloburl = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = bloburl;
    link.download = deck_name.value + "-jank.json";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  import_btn.addEventListener('click', () => { wait_for_deck(); });
  export_btn.addEventListener('click', () => { export_deck(); });
</script>
</html>