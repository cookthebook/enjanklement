<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="css/spectre/spectre.min.css">
  <link rel="stylesheet" href="css/spectre/spectre-exp.min.css">
  <link rel="stylesheet" href="css/spectre/spectre-icons.min.css">
</head>

<body class="container">
  <div id="JankNavbar"></div>

  <div class="container" id="MainContainer" hidden>
    <h2>Deck Checker</h2>
    <p>
      Enter your deck list separated by main/side board.
      Make sure each line is formated <code>cardname #</code>.
      <br>
      Please note that the card name must be <b><i>exact</i></b>, even for double face cards.
    </p>

    <b>Class Refresher</b>
    <p>Both classes have access to a 10 card, 10 point sideboard and up to 6 2-ofs and 3 3-ofs.</p>
    <ul>
      <li><b>JankWalker</b>: 55 card, 22 point mainboard using up to all Standard sets.</li>
      <li><b>JankBringer</b>: 60 card, 22 point mainboard using up to 4 Pioneer sets.</li>
    </ul>

    <b>Feats Refresher</b>
    <ul>
      <li><b>Unga Bunga</b>: Forgo a sideboard to increase starting points by 2.</li>
      <li><b>Double Down</b>: Reduce deck size by 10 cards and 2 points. No 3-ofs allowed. (Incompatible with Down to One)</li>
      <li><b>Down to One</b>: Reduce deck size by 20 cards and 4 points. Singletons only. (Incompatible with Double Down)</li>
      <li><b>Quantum Enjanklement</b>: Spend 1 maindeck point to "enjankle" two legendary cards.</li>
      <li><b>New Toys</b>: If two or more sets are Standard legal, you get +1 set. (Unavailable for JankWalker)</li>
    </ul>

    <div class="form-group p-centered" style="width: 20rem">
      <button class="btn btn-primary" id="importBtn">Import</button>
      <input type="file" id="importFile" hidden></input>

      <label class="form-label">Deck Name</label>
      <input type="text" class="form-input" id="deckName"></input>
      <label class="form-label">Class</label>
      <select class="form-select" id="classSelect">
        <option value="jankwalker">JankWalker</option>
        <option value="jankbringer">JankBringer</option>
      </select>

      <div id="setSelectForm" hidden>
        <label>Set Selection</label>
      </div>

      <label class="form-label">Feats</label>
      <label class="form-switch">
        <input type="checkbox" id="ungaBunga">
        <i class="form-icon"></i> Unga Bunga
      </label>
      <label class="form-switch">
        <input type="checkbox" id="doubleDown">
        <i class="form-icon"></i> Double Down
      </label>
      <label class="form-switch">
        <input type="checkbox" id="downToOne">
        <i class="form-icon"></i> Down to One
      </label>
      <label class="form-switch">
        <input type="checkbox" id="quantumEnjanklement">
        <i class="form-icon"></i> Quantum Enjanklement
      </label>
      <label class="form-switch">
        <input type="checkbox" id="newToys">
        <i class="form-icon"></i> New Toys
      </label>

      <label class="form-label">Main Board</label>
      <div id="mainBoard"></div>

      <label class="form-label">Side Board</label>
      <div id="sideBoard"></div>

      <br />

      <button class="btn btn-primary" id="checkBtn">Check</button>
      <button class="btn btn-primary" id="exportBtn">Export</button>
    </div>
    <div id="checkerOutput" class="p-centered text-center"></div>
  </div>
</body>

<script src="js/fuzzysort.js"></script>
<script type="module" src="js/jank.js"></script>
<script type="module" src="js/card_lister.js"></script>
<script type="module">
  import {
    checker_factory,
    download_sets,
    FORMATS,
    JANKBRINGER_DB,
    JANKWALKER_DB,
    BASIC_LANDS
  } from './js/jank.js';
  import { CardLister } from './js/card_lister.js';

  var deck_name = document.getElementById('deckName');

  var main_list = new CardLister(document.getElementById('mainBoard'));
  var side_list = new CardLister(document.getElementById('sideBoard'));

  var jankwalker_db = null;
  var jankbringer_db = null;
  var check_btn = document.getElementById('checkBtn');
  var import_btn = document.getElementById('importBtn');
  var import_file = document.getElementById('importFile');
  var export_btn = document.getElementById('exportBtn');

  var class_select = document.getElementById('classSelect');
  var set_list = document.getElementById('setSelectForm');

  var unga = document.getElementById('ungaBunga');
  var double_down = document.getElementById('doubleDown');
  var down_to_one = document.getElementById('downToOne');
  var quantum = document.getElementById('quantumEnjanklement');
  var new_toys = document.getElementById('newToys');



  function create_set_select(sets) {
    var ret = document.createElement('div');
    var ret_html = '<select class="form-select">';

    sets = sets.sort();

    sets.forEach(set => {
      ret_html += `<option value="${set}">${set.toUpperCase()}</option>`;
    });
    ret_html += '</select>'
    ret.innerHTML = ret_html;

    return ret;
  }
  function render_set_select() {
    /* leave just the label */
    while (set_list.children.length > 1) {
      set_list.lastChild.remove();
    }

    var set_form = document.createElement('form');
    set_form.classList.add('form-horizontal');
    set_form.id = 'setSelectOptions';
    set_list.appendChild(set_form);

    var set_form_div = document.createElement('div');
    set_form_div.classList.add('form-group');
    set_form.appendChild(set_form_div);

    set_form_div.appendChild(create_set_select(FORMATS['pioneer']));
    set_form_div.appendChild(create_set_select(FORMATS['pioneer']));
    set_form_div.appendChild(create_set_select(FORMATS['pioneer']));

    /* new toys allows for an extra set if two are standard */
    if (new_toys.checked) {
      set_form_div.appendChild(create_set_select(FORMATS['standard']));
      set_form_div.appendChild(create_set_select(FORMATS['standard']));
    } else {
      set_form_div.appendChild(create_set_select(FORMATS['pioneer']));
    }
  }
  function get_set_list() {
    var set_form = document.getElementById('setSelectOptions');

    if (!set_form) {
      return [];
    }

    var ret = [];
    var set_selects = set_form.getElementsByTagName('select');
    for (var set_select of set_selects) {
      ret.push(set_select.value);
    }

    return ret;
  }



  /* new toys is incompatible with jankwalker */
  function select_class() {
    if (class_select.value === 'jankwalker') {
      new_toys.checked = false;
      new_toys.disabled = true;
      main_list.set_card_db(JANKWALKER_DB, BASIC_LANDS);
      side_list.set_card_db(JANKWALKER_DB, BASIC_LANDS);
    } else {
      new_toys.disabled = false;
      render_set_select();
      set_list.hidden = false;
      main_list.set_card_db(JANKBRINGER_DB, BASIC_LANDS);
      side_list.set_card_db(JANKBRINGER_DB, BASIC_LANDS);
    }
  }
  class_select.addEventListener('input', () => {
    select_class();
  });

  /* double_down and down_to_one are mutually exclusive */
  double_down.addEventListener('input', () => {
    if (down_to_one.checked && double_down.checked) {
      down_to_one.checked = false;
    }
  });
  down_to_one.addEventListener('input', () => {
    if (down_to_one.checked && double_down.checked) {
      double_down.checked = false;
    }
  });

  /* re-render set select if new toys gets checked */
  new_toys.addEventListener('input', () => {
    render_set_select();
  });



  function check_deck() {
    /* construct deck checker based on selected options */
    var checker;
    var mods = [];

    if (unga.checked) {
      mods.push('ungabunga');
    }
    if (double_down.checked) {
      mods.push('doubledown');
    }
    if (down_to_one.checked) {
      mods.push('downtoone');
    }
    if (quantum.checked) {
      mods.push('quantumenjanklement');
    }
    if (new_toys.checked) {
      mods.push('newtoys');
    }

    checker = checker_factory(class_select.value, mods, get_set_list());

    var deck = {
      main: main_list.get_card_list(),
      side: side_list.get_card_list()
    };
    console.debug(deck);

    var result = checker.check(deck, document.getElementById('checkerOutput'));
  }



  check_btn.addEventListener('click', () => {
    check_deck();
  });
  var main_container = document.getElementById('MainContainer');
  download_sets().then(() => {
    main_container.hidden = false;
    select_class();
  });


  function import_deck() {
    var file = import_file.files[0];

    file.text().then(text => {
      var parse = JSON.parse(text);
      console.debug(parse);

      deck_name.value = parse.deck_name;
      main_list.import(parse.main);
      side_list.import(parse.side);

      import_file.removeEventListener('change', import_deck);
    });
  }

  function wait_for_deck() {
    import_file.addEventListener('change', import_deck);
    import_file.click();
  }

  function export_deck() {
    var output = {
      deck_name: deck_name.value,
      main: main_list.get_card_list(),
      side: side_list.get_card_list()
    };
    var blob = new Blob([JSON.stringify(output, null, 2)]);
    const bloburl = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = bloburl;
    link.download = deck_name.value + "-jank.json";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  import_btn.addEventListener('click', () => { wait_for_deck(); });
  export_btn.addEventListener('click', () => { export_deck(); });
</script>
</html>